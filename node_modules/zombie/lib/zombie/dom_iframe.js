// Generated by CoffeeScript 1.4.0
var HTML, createHistory;

createHistory = require("./history");

HTML = require("jsdom").dom.level3.html;

HTML.Document.prototype._elementBuilders["iframe"] = function(document, tag) {
  var create, iframe, parent, window;
  parent = document.window;
  iframe = new HTML.HTMLIFrameElement(document, tag);
  Object.defineProperties(iframe, {
    contentWindow: {
      get: function() {
        return window || create();
      }
    },
    contentDocument: {
      get: function() {
        return (window || create()).document;
      }
    }
  });
  window = null;
  create = function(url) {
    var focus, open;
    focus = function(active) {
      return window = active;
    };
    open = createHistory(parent.browser, focus);
    return window = open({
      name: iframe.name,
      parent: parent,
      url: url
    });
  };
  iframe.setAttribute = function(name, value) {
    var url;
    if (name === "src" && value) {
      url = HTML.resourceLoader.resolve(parent.document, value);
      if (window) {
        window.location = url;
      } else {
        create(url);
      }
      window.addEventListener("load", function() {
        var onload;
        onload = document.createEvent("HTMLEvents");
        onload.initEvent("load", true, false);
        return iframe.dispatchEvent(onload);
      });
      return HTML.HTMLElement.prototype.setAttribute.call(this, name, value);
    } else {
      return HTML.HTMLFrameElement.prototype.setAttribute.call(this, name, value);
    }
  };
  return iframe;
};
