function Document(){"use strict";if(!(this instanceof Document))return new Document;var t,e=new Converter(NEWSLETTER.formatMapper||new Mapper);this.getConverter=function(){return e};var n;this.getFactory=function(){return n},this.setFactory=function(t){n=t},this.setWrapCss=function(e){t=e instanceof Properties?e:new Properties(e),t.setMode(Properties.MODE_STYLE)},this.getWrapCss=function(){return t},this.docHtml=function(t){var e=this.getWrapCss(),n=e?e.toString():"";n&&(n=' style="'+n+'"');var i=t instanceof Node?t.innerHTML:"",r='<!DOCTYPE html>\n<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8">\n</head>\n<body>\n',o="<center>\n<div"+n+">\n"+i+"\n</div>\n</center>\n",s="</body>\n</html>";return r+o+s},this.convertTo=function(t,e){var n=this.getConverter();return"function"==typeof n.convertTo?n.convertTo(e,t):void 0},this.findAncestor=function(t,e,n){var i=void 0!==n;if(n&&"function"==typeof n.contains&&!n.contains(t))throw new Error("Wrong scope!");if("function"!=typeof e)throw new Error("Criteria must be a function!");for(var r,o=t;o&&(!i||n.contains(o));)try{if(r=e(o))return o}catch(s){console.log("Error ("+s.name+") when applying criteria to a node: "+s.message)}finally{o=o.parentNode}},this.findAncestorsOfMany=function(t,e){if(!Array.isArray(t)||"function"!=typeof e)return void 0;var n=[];return t.forEach(function(t){var i=this.findAncestor(t,e);i&&-1===n.indexOf(i)&&n.push(i)}.bind(this)),n},this.nodesBetween=function(t,e){if(!(t instanceof Node&&e instanceof Node))return[];if(t===e)return[t];var n=this.commonAncestor(t,e);if(!n)return[];var i=this.pathTo(t,n),r=this.pathTo(e,n);if(0===i.length)return[t];if(0===r.length)return[e];var o,s,a,c,f=i[0],h=r[0],u=[],d=this.compare(i,r);if(1===d||-1===d){1===d?(o=e,s=t,a=h,c=f):(o=t,s=e,a=f,c=h),u.push(o);var l=this.bunchNextSiblings(o,n.childNodes[a]),p=this.bunchPrevSiblings(s,n.childNodes[c]);Array.isArray(l)&&l.length>0&&(u=u.concat(l));var g;for(g=a+1;c>g;g++)u.push(n.childNodes[g]);return Array.isArray(p)&&p.length>0&&(u=u.concat(p)),u.push(s),u}},this.compare=function(t,e,n){var i=function(t,e,n,r){if(!(t.length>n))return e.length===n?0:-1;if(e.length===n)return 1;var o=t[n],s=e[n],a=r(o,s);return 1===a||-1===a?a:0===a?i(t,e,n+1,r):void 0};if(Array.isArray(t)&&Array.isArray(e)){var r="function"==typeof n?n:function(t,e){return t===e?0:t>e?1:-1};return i(t,e,0,r)}},this.commonAncestor=function(t,e){if(t instanceof Node&&e instanceof Node){if(this.contains(t,e))return t;if(this.contains(e,t))return e;for(var n=t.parentNode;n&&!this.contains(n,e);)n=n.parentNode;return n}},this.pathTo=function(t,e){if(t instanceof Node&&(e instanceof Node||void 0===e)){for(var n=void 0!==e,i=[],r=t;r.parentNode&&r!==e;)i.unshift(this.indexOf(r)),r=r.parentNode;return n&&e.parentNode&&!r.parentNode?void 0:i}}.bind(this),this.indexOf=function(t){if(!(t instanceof Node))throw new Error("The argument must be a Node instance!");for(var e=0,n=t.previousSibling;n;)e++,n=n.previousSibling;return e};var i=function(t,e,n){for(var i,r=[],o=t;!e.isEqualNode(o);)i=n(o),r=r.concat(i),o=o.parentNode;return r};this.bunchNextSiblings=function(t,e){return t instanceof Node&&e instanceof Node&&this.contains(e,t)?i(t,e,this.nextSiblings):void 0},this.bunchPrevSiblings=function(t,e){return t instanceof Node&&e instanceof Node&&this.contains(e,t)?i(t,e,this.prevSiblings):void 0};var r=function(t,e){for(var n=[],i=t[e];i;)n.push(i),i=i[e];return n};this.contains=function(t,e){if(!(t instanceof Node&&e instanceof Node))throw new Error("Both arguments must be Node instances!");for(var n=e;n;){if(n===t)return!0;n=n.parentNode}return!1},this.nextSiblings=function(t){return t instanceof Node?r(t,"nextSibling"):void 0},this.prevSiblings=function(t){return t instanceof Node?r(t,"previousSibling"):void 0},this.isTextNode=function(t){return t instanceof Node&&t.nodeType===Node.TEXT_NODE},this.detachBoundaries=function(t){if(!(t instanceof Range))throw new Error("The argument must be a Range instance!");if(t.collapsed)return[];var e=t.startContainer,n=t.endContainer,i=t.startOffset,r=t.endOffset,o=e===n,s=[];return this.isTextNode(e)?(o?this.spliceText(e,[i,r]):this.spliceText(e,[i]),s.push(e.nextSibling)):s.push(e.childNodes[i]),this.isTextNode(n)?o||(this.spliceText(n,[r]),s.push(n)):s.push(n.childNodes[r-1]),s},this.spliceText=function(t,e){if(t instanceof Text&&Array.isArray(e)){var n=e.length;if(0!==n)for(var i,r=0,o=0,s=t;n>r;)i=e[r]-o,i>0&&i<s.textContent.length&&(s=s.splitText(i)),o=e[r],r++}},this.nodesOfRange=function(t){if(!(t instanceof Range))throw new Error("The argument must be a Range instance!");if(t.collapsed)return[];var e=this.detachBoundaries(t);return 0===e.length?[]:1===e.length?[e[0]]:this.nodesBetween(e[0],e[1])},this.proxy=function(t){return t instanceof Node?t instanceof Element?t:t.nextSibling||t.previousSibling?t:t.parentNode:null},this.getInheritedStyleProp=function(t,e,n){if(void 0===e)throw new Error("Starting node must be defined!");var i,r=e,o=void 0===n||!n.contains(e);if(o)for(;r;){if("function"==typeof r.getAttribute&&(i=new Properties(r.getAttribute("style")),i.hasProperty(t)))return i.getProperty(t);r=r.parentNode}if(!o)for(;r&&n.contains(r);){if("function"==typeof r.getAttribute&&(i=new Properties(r.getAttribute("style")),i.hasProperty(t)))return i.getProperty(t);r=r.parentNode}},this.getMentor=function(t,e){for(var n,i=e;i;){if("function"==typeof i.getAttribute&&(n=new Properties(i.getAttribute("style")),n.hasProperty(t)))return i;i=i.parentNode}},this.getStyleProperty=function(t,e){if(t&&e&&"function"==typeof t.getAttribute){var n=new Properties(t.getAttribute("style"));if(n.hasProperty(e))return n.getProperty(e)}},this.dropStyleProperty=function(t,e){if(t instanceof Node&&"string"==typeof e&&t.style){t.style.removeProperty(e);var n="style",i=t.getAttribute(n);""===i&&t.removeAttribute(n)}},this.complementNodes=function(t,e){if(!t.contains(e))throw new Error("Start node must contain the end one!");if(t.isEqualNode(e))return[];var n,i,r=t.childNodes,o=r.length,s=[];for(n=0;o>n;n++)i=r[n],i.contains(e)?s=s.concat(this.complementNodes(i,e)):s.push(i);return s},this.insertAt=function(t,e,n){t instanceof Node&&(t.nodeType===Node.TEXT_NODE?this.insertIntoText(t,e,n):this.insertChild(t,e,n))},this.updateNode=function(t,e){console.log("updating ",t,"by template",e)},this.getAvailableWidth=function(t){var e="width",n=this.getMentor(e,t);return n?n.style[e]:void 0},this.insertChild=function(t,e,n){var i,r=t.childNodes;if(n>r.length)throw console.log(n,r.length),new Error("offset is too big!");if(n===r.length)t.appendChild(e);else{if(i=r[n],!i)throw new Error("Wrong offset to insert node at!");t.insertBefore(e,i)}},this.insertIntoText=function(t,e,n){if(e instanceof Text){var i,r=t.nodeValue,o=e.nodeValue;return i=r.slice(0,n)+o+r.slice(n),t.nodeValue=i,t}if(0===n)t.parentNode.insertBefore(e,t);else{var s,a;a=t.nodeValue.length,a>n&&(s=t.splitText(n),t.parentNode.insertBefore(e,s)),n===a&&(s=t.nextSibling,s?t.parentNode.insertBefore(e,s):t.parentNode.appendChild(e))}},this.selectionToList=function(t,e){Array.isArray(t)&&t.forEach(function(t){this.rangeToList(t,e)}.bind(this))},this.rangeToList=function(t,e){var n=this.getFactory();if(n){var i=new List(e),r=t.startContainer,o=t.startOffset,s=this.nodesOfRange(t),a=[];s&&s.forEach(function(t){try{var e=n.mimic(t);a.push(e),this.removeNode(t)}catch(i){console.log(i.name+" occurred when creating list item: "+i.message)}}.bind(this)),a.push(""),i.appendAsItems(a),this.insertAt(r,i.toNode(),o)}},this.setListNodeType=function(t,e){try{var n,i=this.getFactory().mimic(t);return i instanceof List?(i.switchName(e),n=t.parentNode,n.replaceChild(i.toNode(),t),!0):!1}catch(r){return console.log("Error ("+r.name+") when switching a list type: "+r.message),!1}},this.convertToBold=function(t){this.updateRangesStyleProp(t,"font-weight","bold")},this.convertToItalics=function(t){this.updateRangesStyleProp(t,"font-style","italic")},this.convertToStroked=function(t){this.updateRangesStyleProp(t,"text-decoration","line-through")},this.convertToUnderlined=function(t){this.updateRangesStyleProp(t,"text-decoration","underline")},this.updateRangesStyleProp=function(t,e,n){Array.isArray(t)&&t.forEach(function(t){this.modifyRangeStyleProperty(t,e,n)}.bind(this))},this.modifyRangeStyleProperty=function(t,e,n){var i;try{i=this.nodesOfRange(t)}catch(r){return void console.log("Error ("+r.name+") when retrieving nodes of the range: "+r.message)}this.accentuateNodesStyleProperty(i,e,n)},this.accentuateNodesStyleProperty=function(t,e,n){if(!Array.isArray(t))throw new Error("Set of nodes must be given as an array!");t.forEach(function(t){t instanceof Node&&this.accentuateSingleNodeStyleProperty(t,e,n)}.bind(this))},this.accentuateSingleNodeStyleProperty=function(t,e,n){var i=this.getMentor(e,t);if(i instanceof Element){var r=this.getStyleProperty(i,e);if(r===n)return;this.dropStyleProperty(i,e);var o=this.complementNodes(i,t);o.forEach(function(t){this.suggestStyleProperty(t,e,r)}.bind(this))}var s=this.proxy(t);this.setStyleProperty(s,e,n)},this.setStyleProperty=function(t,e,n){if(t instanceof Node&&"string"==typeof e&&""!==e&&("string"==typeof n||"number"==typeof n)&&""!==n){var i,r;if(t instanceof Element)i=t;else{var o=t.parentNode,s=document.createElement("span");o.insertBefore(s,t),s.appendChild(t),i=s}r=new Properties(i.getAttribute("style")),r.setMode(Properties.MODE_STYLE),r.setProperty(e,n),i.setAttribute("style",r.toString())}},this.suggestStyleProperty=function(t,e,n){if(!(t instanceof Node))throw new Error("It is illegal to suggest a property to a non-Node instance!");if(t.getAttribute){var i=t.getAttribute("style"),r=new Properties(i);if(r.hasProperty(e))return}this.setStyleProperty(t,e,n)},this.isImage=function(t){return t instanceof Element&&"img"===t.tagName.toLowerCase()},this.isLink=function(t){return t instanceof Element&&"a"===t.tagName.toLowerCase()},this.isTable=function(t){return t instanceof Element&&"table"===t.tagName.toLowerCase()},this.applyToDesOfManyRanges=function(t,e,n,i){t.forEach(function(t){t instanceof Range&&this.applyToDesOfSingleRange(t,e,n,i)}.bind(this))},this.clearRangesFromTables=function(t){this.applyToAncOfManyRanges(t,this.isTable,this.removeNode,!0)},this.applyToAncOfManyRanges=function(t,e,n){t.forEach(function(t){t instanceof Range&&this.applyToAncOfSingleRange(t,e,n)}.bind(this))},this.applyToAncOfSingleRange=function(t,e,n){var i=t.collapsed?[t.startContainer]:this.nodesOfRange(t),r=this.findAncestorsOfMany(i,e);r.forEach(function(t){try{n(t)}catch(e){return}}.bind(this))},this.deparentize=function(t){var e=t.parentNode;if(e){if(t instanceof Element){var n,i=t.childNodes.length;for(n=0;i>n;n++)e.insertBefore(t.childNodes[0],t)}this.removeNode(t)}},this.applyToDesOfSingleRange=function(t,e,n,i){var r=this.nodesOfRange(t);r.forEach(function(t){this.applyToDesOfSingleNode(t,e,n,i)}.bind(this))},this.applyToDesOfSingleNode=function(t,e,n,i){var r,o=void 0===i?!0:i;try{r=e(t)}catch(s){console.log("Error ("+s.name+") when applying criteria to a node: "+s.message),r=!1}if(r){try{n(t)}catch(s){console.log("Error ("+s.name+") when applying operation to a node: "+s.message)}if(o)return}var a,c=t.childNodes,f=c.length;for(a=f-1;a>=0;a--)this.applyToDesOfSingleNode(c.item(a),e,n,i)},this.removeNode=function(t){var e=t.parentNode;e&&e.removeChild(t)},this.insertColumn=function(t,e){console.log(t,e)},this.findSelectionFirstAncestor=function(t,e){var n,i,r=t.length;for(i=0;r>i;i++)if(n=this.findRangeFirstAncestor(t[i],e))return n},this.findRangeFirstAncestor=function(t,e){if(t.collapsed)return this.findAncestor(t.startContainer,e);var n,i,r=this.nodesOfRange(t),o=r.length;for(n=0;o>n;n++)if(i=this.findAncestor(r[n],e))return i},this.selectionToString=function(t,e){var n=[];return t.forEach(function(t){n.push(t.toString())}),n.join(e||"")},this.createFromTemplate=function(t){try{return this.getFactory().createFromTemplate(t)}catch(e){console.log(e.name+" occurred when delegating creation of a node from template: "+e.message)}},this.replaceChild=function(t,e){var n=e.parentNode;n&&n.replaceChild(t,e)},this.isNodeEditable=function(t){try{return t.nodeType===Node.TEXT_NODE||1===t.childNodes.length&&t.firstChild.nodeType===Node.TEXT_NODE}catch(e){return!1}},this.isSelectionEditable=function(t){return 1!==t.length?!1:this.isRangeEditable(t[0])},this.isRangeEditable=function(t){if(!(t instanceof Range))return!1;if(t.collapsed)return!0;var e=this.nodesOfRange(t);return e.length>1?!1:this.isNodeEditable(e[0])},this.modifyLink=function(t,e){var n,i,r=e.attributes,o=r.length;for(i=0;o>i;i++)n=r.item(i),n&&t.setAttribute(n.name,n.value);this.isNodeEditable(t)&&(t.innerHTML=e.innerHTML)},this.selectionToLink=function(t,e){console.log(t,e),t.forEach(function(t){this.rangeToLink(t,e)}.bind(this))},this.rangeToLink=function(t,e){t.collapsed&&this.insertAt(t.startContainer,e,t.startOffset);var n=this.nodesOfRange(t);console.log(n),n.forEach(function(t){this.nodeToLink(t,e)}.bind(this))},this.nodeToLink=function(t,e){console.log("nodeToLink",t,e);var n=t.parentNode;n&&(n.insertBefore(e,t),e.appendChild(t),this.clearNodeFromLink(t))},this.clearNodeFromLink=function(t){this.applyToDesOfSingleNode(t,this.isLink,this.deparentize,!0)},this.replaceSelectionByLink=function(t,e){var n=t[0];if(n.collapsed)return void this.insertAt(n.startContainer,e,n.startOffset);var i,r=this.nodesOfRange(n);r.length>0&&(i=r[0].parentNode,i&&i.replaceChild(e,r[0]))}}