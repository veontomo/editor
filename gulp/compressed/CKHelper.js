var CKHelper={findAscendant:function(e,t){if("function"!=typeof t)return null;for(;e&&e.type===CKEDITOR.NODE_ELEMENT;){if(t(e))return e;e=e.getParent()}return null},dropInlineStyleAttr:function(e,t){var n=e.attr("style"),r=new Properties(n);r.dropProperty(t),r.setMode(1),e.attr("style",r.toString())},unlink:function(e,t){if(!(e instanceof CKEDITOR.editor&&t instanceof CKEDITOR.dom.element))return null;var n=t.$,r=n.parentNode,i=n.nextSibling,o=NEWSLETTER.factory,a=o.mimic(n);a.getContent().getElements().forEach(function(e){r.insertBefore(e.toNode(),i)}),n.remove()},dropRow:function(e){var t,n,r=CKHelper.findAscendant(e.getSelection().getStartElement(),function(e){return"tr"===e.getName()&&"Row"===e.getAttribute(NEWSLETTER["marker-name"])});r&&(t=CKHelper.findAscendant(r,function(e){return"table"===e.getName()}),r.remove(),n=t.getElementsByTag("tr").count(),0===n&&t.remove())},isEditor:function(e){return e instanceof CKEDITOR.editor},isSelection:function(e){return e instanceof CKEDITOR.dom.selection},insertRow:function(e,t){for(var n,r,i,o,a,l,E,s="tr",u=NEWSLETTER["marker-name"],c="Row",f=e.getSelection().getStartElement(),m=f.getAscendant(s,!0);m.getName()!==s||m.getAttribute(u)!==c;)if(m=m.getParent(),!m||m.type!==CKEDITOR.NODE_ELEMENT)return null;if(n=new CKEDITOR.dom.element(s),r="insert"+Helper.firstLetterUpperCase(t),i=m.getChildren(),o=i.count(),void 0===n[r])return null;for(n[r](m),m.copyAttributes(n),a=0;o>a;a++)l=i.getItem(a),E=new CKEDITOR.dom.element(l.getName()),E.setHtml(m.getChild(a).getHtml()),n.append(E),l.copyAttributes(E)},insertColumn:function(e,t){if("before"!==t&&"after"!==t)return null;var n,r,i,o,a,l,E,s,u,c,f,m,p,g;n=CKHelper.findAscendant(e.getSelection().getStartElement(),function(e){var t=(new Cell).getName();return"td"===e.getName()&&e.getAttribute(NEWSLETTER["marker-name"])===t}),l=CKHelper.findAscendant(e.getSelection().getStartElement(),function(e){var t=(new Table).getName();return"table"===e.getName()&&e.getAttribute(NEWSLETTER["marker-name"])===t}),a=n.getIndex(),r=NEWSLETTER.factory.mimic(n.$),p=NEWSLETTER.factory.mimic(l.$),i=r.getStyles(),o=r.getProperties(),f=p.getProfile().map(function(e){return parseFloat(e)}),E=Helper.crack(f,a),s=new Cell("cella"),u=new Properties(o),c=new Properties(i),"before"===t&&(g=0,c.setProperty("padding-right",0),p.appendStyleToCol(a,"padding-left: 0px")),"after"===t&&(g=1,c.setProperty("padding-left",0),p.appendStyleToCol(a,"padding-right: 0px")),s.setProperties(u),s.setStyles(c),s.setProperty(NEWSLETTER["marker-name"],(new Cell).getName()),p.insertColAt(a+g,s),p.setProfile(E),m=CKEDITOR.dom.element.createFromHtml(p.toHtml()),l.remove(),e.insertElement(m)},nodeString:function(e){return e.type===CKEDITOR.NODE_ELEMENT?e.getOuterHtml():e.type===CKEDITOR.NODE_TEXT?e.getText():"..."},nodeOffsetString:function(e,t,n){if(e.type===CKEDITOR.NODE_ELEMENT)return CKHelper.nodeString(e.getChild(t));if(e.type===CKEDITOR.NODE_TEXT){if("start"===n||void 0===n)return e.getText().substring(0,t);if("end"===n)return e.getText().substring(t)}return"wrong"},insertNode:function(e,t){t.type===CKEDITOR.NODE_ELEMENT&&e.push(t)},arrayToText:function(e,t){return t=t||"",e.map(function(e){var t;switch(e.type){case CKEDITOR.NODE_ELEMENT:t=e.textContent;break;case CKEDITOR.NODE_TEXT:t=e.getText();break;default:t="..."}return t}).join(t)},doesOverlap:function(e,t){var n=!1;return n=e.type===t.type&&e.type===CKEDITOR.NODE_ELEMENT?e.equals(t)||e.contains(t)||t.contains(e):e.type===CKEDITOR.NODE_ELEMENT?e.contains(t):e.type===CKEDITOR.NODE_ELEMENT?t.contains(e):e.equals(t)},insertList:function(e,t){var n=new Selection(e),r=n.nodes,i=NEWSLETTER.factory;console.log("CKHelper::insertListNew ",r),r.forEach(function(n){var r,o,a,l,E,s=n.length;if(o=new List(t),0===s)return o.appendElem(new ListItem),l=CKEDITOR.dom.element.createFromHtml(o.toHtml()),e.insertElement(l),null;if(E=n.shift().$,1===s&&E.nodeType===Node.ELEMENT_NODE)return r=i.mimic(E),a=r.getContent(),o=new List(t),o.appendAsItems(a),r.setElements([o]),l=r.toNode(),E.parentNode.replaceChild(l,E),null;var u=[i.mimic(E)];n.forEach(function(e){u.push(i.mimic(e.$)),e.$.remove()}),o.appendAsItems(u),l=o.toNode(),E.parentNode.replaceChild(l,E)})},changeListType:function(e,t,n){var r,i,o;t&&(r=new List,r.load(t.$),r.switchName(n),r.trim(),o=r.toHtml(),i=CKEDITOR.dom.element.createFromHtml(o),t.remove(),e.insertElement(i))},"next-siblings":function(e){for(var t=[],n=e;n.hasNext();)n=n.getNext(),t.push(n);return t},"prev-siblings":function(e){for(var t=[],n=e;n.hasPrevious();)n=n.getPrevious(),t.push(n);return t},"bunch-next-siblings":function(e,t){if(e.equals(t))return[e];if(!t.contains(e))return[];for(var n=[e],r=e,i=r.getParent(),o=CKHelper["next-siblings"];!t.equals(i);)n=n.concat(o(r)),r=i,i=i.getParent();return n=n.concat(o(r))},"bunch-prev-siblings":function(e,t){if(e.equals(t))return[e];if(!t.contains(e))return[];for(var n=[e],r=e,i=r.getParent(),o=CKHelper["prev-siblings"];!t.equals(i);)n=n.concat(o(r)),r=i,i=i.getParent();return n=n.concat(o(r))},childWithNode:function(e,t){var n,r,i,o;if(e.contains(t))for(n=e.getChildren(),r=n.count(),i=0;r>i;i++)if(o=n.getItem(i),CKHelper.containsOrEqual(o,t))return o;return null},containsOrEqual:function(e,t){var n=e.type;return n===CKEDITOR.NODE_ELEMENT?e.contains(t)||e.equals(t):n===CKEDITOR.NODE_TEXT?e.equals(t):!1}};