function Table(){"use strict";if(!(this instanceof Table))return new Table;Tag.call(this),this.setTag("table"),this.setName("Table"),this.setProperties(new TableProperties);var t,e,r;this.initPhantoms=function(){e instanceof Row||(e=new Row),t instanceof Cell||(t=new Cell),r instanceof Table||(r=new Table)},this.getPhantomCellStyles=function(){return t instanceof Cell?t.getStyles():void 0},this.setPhantomCellStyles=function(e){void 0!==e&&(this.initPhantoms(),t.setStyles(e instanceof Properties?e:new Properties(e)))},this.getPhantomRowStyles=function(){return e instanceof Row?e.getStyles():void 0},this.setPhantomRowStyles=function(t){void 0!==t&&(this.initPhantoms(),e.setStyles(t instanceof Properties?t:new Properties(t)))},this.getPhantomTableStyles=function(){return r instanceof Table?r.getStyles():void 0},this.setPhantomTableStyles=function(t){void 0!==t&&(this.initPhantoms(),r.setStyles(t instanceof Properties?t:new Properties(t)))},this.getPhantomCellAttributes=function(){return t instanceof Cell?t.getProperties():void 0},this.setPhantomCellAttributes=function(e){this.initPhantoms(),t.setProperties(e)},this.getPhantomRowAttributes=function(){return e instanceof Row?e.getProperties():void 0},this.setPhantomRowProperties=function(t){this.initPhantoms(),e.setProperties(t)},this.setPhantomCellProperties=function(e){this.initPhantoms(),t.setProperties(e)},this.getPhantomTableAttributes=function(){return r instanceof Table?r.getProperties():void 0},this.setPhantomTableProperties=function(t){this.initPhantoms(),r.setProperties(t)},this.getPhantomTableProperties=function(){return this.initPhantoms(),r.getProperties()},this.getPhantomCellProperties=function(){return t.getProperties()},this.getPhantomRowProperties=function(){return e.getProperties()},this.getPhantomTag=function(o,i){if("string"==typeof o){var n=o.toLowerCase(),s="string"==typeof i&&"close"===i.toLowerCase()?"closingTag":"openingTag";if("cell"===n&&void 0!==t&&"function"==typeof t[s])return t[s]();if("row"===n&&void 0!==e&&"function"==typeof e[s])return e[s]();if("table"===n&&void 0!==r&&"function"==typeof r[s])return r[s]()}},this.rowNum=function(){var t=this.getBody();return t?t.length:0},this.setBody=function(t){var e,r=Array.isArray(t)?t:[t];if(e=r.every(function(t){return t instanceof Row}),!e)throw new Error("Instance of Row class is required to be set as tbody!");var o=this.getContent(),i=o.findTagPos("tbody"),n=new Tag("tbody");n.setElements(r),i.length>0&&(i.sort(function(t,e){return e-t}),i.forEach(function(t){o.dropElemAt(t)})),o.appendElem(n),this.setContent(o)},this.setElements=function(t){this.setBody(t)},this.getBody=function(){var t=this.getContent(),e=t.getFirstEntryOfTag("tbody");return e?e.getElements():[]},this.getFooter=function(){var t=this.getContent();return t?t.getFirstEntryOfTag("tfoot"):void 0},this.getHeader=function(){var t=this.getContent();return t?t.getFirstEntryOfTag("thead"):void 0},this.getCaption=function(){var t=this.getContent();return t?t.getFirstEntryOfTag("caption"):void 0},this.appendRow=function(t){if(!(t instanceof Row))throw new Error("The argument is not a Row instance!");var e=this.getContent(),r=e.getFirstEntryOfTag("tbody");r?r.appendElem(t):(r=new Tag("tbody"),r.setElements([t]),e.appendElem(r)),this.setContent(e)},this.getMatrix=function(){var t,e=[],r=this.rowNum(),o=this.getBody();for(t=0;r>t;t++)e.push(o[t].getCellWidths());return e},this.getProfile=function(){var t=this.isSameWidths()?this.getMatrix()[0]:null;return t},this.setProfile=function(t){var e,r=this.rowNum(),o=this.colNum();if(!Array.isArray(t))throw new Error("Wrong argument type: array expected.");if(t.length!==o)throw new Error("Wrong input array length!");var i=this.getBody();for(e=0;r>e;e++)i[e].setCellWidths(t);this.setBody(i)},this.insertColAt=function(t,e){e=e||new Cell;var r,o=this.colNum(),i=this.rowNum(),n=this.getBody();if(0>=o||0>t||t>o)throw new Error("Wrong index for the cell to insert!");if(o>t)for(r=0;i>r;r++)n[r].insertCellAt(t,e);else for(r=0;i>r;r++)n[r].appendCell(e);return this.setBody(n),null},this.knockOutCol=function(t){var e,r=this.rowNum(),o=this.getBody();for(e=0;r>e;e++)o[e].knockOutCell(t);this.setBody(o)},this.dropColAt=function(t){var e,r=this.rowNum(),o=this.getBody();for(e=0;r>e;e++)o[e].dropCellAt(t);this.setBody(o)},this.colNum=function(){var t,e,r,o=this.rowNum();if(0===o)return 0;if(r=this.getBody(),t=r[0].cellNum(),1===o)return t;for(e=1;o>e;e++)if(r[e].cellNum()!==t)return null;return t},this.isSameWidths=function(){var t,e,r,o,i=this.getMatrix(),n=i.length,s=!0;if(n>1)for(t=i[0],e=t.length,r=1;n>r;r++){if(i[r].length!==e){s=!1;break}for(o=0;e>o;o++)if(i[r][o]!==t[o]){s=!1;break}if(!s)break}return s},this.setBorder=function(t){var e=this.getProperties();e.setBorder(t),this.setProperties(e)},this.getBorder=function(){return this.getProperties().getBorder()},this.removeBorder=function(){var t=this.getProperties();t.removeBorder(),this.setProperties(t)},this.isFragmented=function(){return 0===this.rowNum()?!1:this.getBody().every(function(t){var e=t.onlyTableInside();return e})},this.isFramed=function(){return void 0!==e||void 0!==t||void 0!==r},this.unsetPhantom=function(){e=void 0,t=void 0,r=void 0},this.appendStyleToCol=function(t,e){var r,o=parseInt(t,10),i=this.colNum(),n=this.rowNum(),s=this.getBody();if(!(o===t&&t>=0&&i>t))throw new Error("The column is not present!");for(r=0;n>r;r++)s[r].appendStyleToCellAt(t,e);this.setBody(s)},this.bodyToHtml=function(){var t="",e="",r="";return this.isFramed()&&(e=this.getPhantomTag("row","open")+this.getPhantomTag("cell","open")+this.getPhantomTag("table","open"),t=this.getPhantomTag("table","close")+this.getPhantomTag("cell","close")+this.getPhantomTag("row","close")),this.getBody().forEach(function(o){"function"==typeof o.toHtml&&(r+=e+o.toHtml()+t)}),r},this.toHtml=function(){var t=this.openingTag(),e=this;return this.getElements().forEach(function(r){"function"==typeof r.toHtml&&(t+="tbody"===r.getTag()?r.openingTag()+e.bodyToHtml()+r.closingTag():r.toHtml())}),t+=this.closingTag()},this.toNode=function(){var o=document.createElement(this.getTag());if(this.getProperties().decorateElement(o),this.isFramed()){var i=this.getBody();i.forEach(function(i){var n=i.toNode(),s=e.toNode(),l=t.toNode(),a=r.toNode();s.appendChild(l),l.appendChild(a),a.appendChild(n),o.appendChild(s)})}else this.getContent().stickTo(o);return o},this.getPhantomRowProp=function(t){if(!this.isFragmented())return null;var e,r,o,i=this.getFirst(),n=this.rowNum();switch(t){case"attr":o=i.getProperties();break;case"style":o=i.getStyles();break;default:return null}if(1===n)return o;if("function"!=typeof o.isTheSameAs)return null;for(r=1;n>r;r++)if(e="style"===t?this.getElem(r).getStyles():"attr"===t?this.getElem(r).getProperties():null,!o.isTheSameAs(e))return null;return o},this.getRow=function(t){if(void 0!==t){var e=this.rowNum();if(e>0&&t>=0&&e>t)return this.getBody()[t]}},this.getFirstRow=function(){return this.rowNum()>0?this.getBody()[0]:void 0},this.getLastRow=function(){var t=this.rowNum();return t>0?this.getBody()[t-1]:void 0},this.getPhantomCellProp=function(t){if(!this.isFragmented())return null;var e,r,o,i=this.rowNum(),n=this.getFirst();if(e=n.getPhantomCellProp(t),1===i)return e;for(r=1;i>r;r++)if(o=this.getElem(r).getPhantomCellProp(t),!e.isTheSameAs(o))return null;return e},this.getPhantomTableProp=function(t){if(!this.isFragmented())return null;var e,r,o,i=this.rowNum(),n=this.getFirst();if(e=n.getPhantomTableProp(t),1===i)return e;for(r=1;i>r;r++)if(o=this.getElem(r).getPhantomTableProp(t),!e.isTheSameAs(o))return null;return e},this.disentangle=function(){if(!this.isFragmented())return null;var t,e,r,o,i,n=[],s=this.rowNum();if(i=this.getBody(),e=this.getFirstRow(),e&&(this.setPhantomRowProperties(e.getProperties()),r=e.getFirst(),r&&(this.setPhantomCellProperties(r.getProperties()),o=r.getFirst()))){for(this.setPhantomTableProperties(o.getProperties()),t=0;s>t;t++)try{n.push(i[t].getFirst().getFirst().getFirstRow())}catch(l){console.log("Error ("+l.name+") when retrieving nested rows "+l.message)}try{this.setBody(n)}catch(l){console.log("Error ("+l.name+") when setting table body "+l.message)}}},this.makeShape=function(t,e,r){if(void 0===t)throw new Error("Number of rows and columns are missing.");if(parseInt(t,10)!==t||0>=t)throw new Error("Number of rows must be positive integer.");var o,i,n,s="function"==typeof r;for(this.flushContent(),o=0;t>o;o++)i=new Row,s?(n=function(t){return r(o,t)},i.makeShape(e,n)):i.makeShape(e),this.appendRow(i)},this.markRows=function(t){var e,r,o=this.rowNum(),i=new Content;for(e=0;o>e;e++)r=this.getElem(e),r&&"function"==typeof r.mark&&(r.mark(t),i.appendElem(r));this.setContent(i)},this.configureProperties=function(t){console.log("configuring properties: ",t);var e,r,o=t.width,i=t.tableBorderWidth,n=t["border-spacing"],s=o.clone(),l=n.frac(2,0);t.margin.getValue()>0&&(this.setStyleProperty("margin",t.margin.toString()),s=s.sub(t.margin.times(2)));var a=t.padding;if(this.setStyleProperty("padding",a.toString()),this.setProperty("cellspacing",a.getValue()),s=s.sub(a.times(2)),i.getValue()>0&&(s=s.sub(i.times(2)),this.setBorder({style:"solid",color:t.tableBorderColor,width:i.getValue()})),this.setWidth(s.getValue()),this.setStyleProperty("border-spacing","0px "+l.toString()),t.globalTableBgColor&&this.setStyleProperty("background-color",t.globalTableBgColor),t.phantomBorderWidth.getValue()>0){var h=new RowProperties,u=new CellProperties,g=new TableProperties;h.setStyleProperty("padding",0),h.setStyleProperty("margin",0),u.setStyleProperty("padding",0),u.setStyleProperty("margin",0),h.setWidth(s.getValue()),u.setWidth(s.getValue()),g.setBorder({style:"solid",color:t.phantomBorderColor,width:t.phantomBorderWidth.getValue()}),s=s.sub(t.phantomBorderWidth.times(2)),g.setWidth(s.getValue()),this.setPhantomRowProperties(h),this.setPhantomCellProperties(u),this.setPhantomTableProperties(g)}this.setAllRowWidths(s.getValue()),e=Helper.columnWidths2(s.getValue(),t.cellWeights);var f=t.cellBorderWidth.toString()+" solid "+t.cellBorderColor;if(t.cellBorders.topHor&&this.setStylePropertyOfBlock("border-top",f,[0]),t.cellBorders.bottomHor&&t.rows>0&&this.setStylePropertyOfBlock("border-bottom",f,[t.rows-1]),t.cellBorders.intHor){var d=[];for(r=1;r<t.rows;r++)d.push(r);this.setStylePropertyOfBlock("border-top",f,d)}if(t.cellBorders.leftVer&&(this.setStylePropertyOfBlock("border-left",f,null,[0]),e[0]-=t.cellBorderWidth.getValue()),t.cellBorders.rightVer&&(this.setStylePropertyOfBlock("border-right",f,null,[t.cols-1]),e[e.length-1]-=t.cellBorderWidth.getValue()),t.cellBorders.intVer){var c=[];for(r=1;r<t.cols;r++)c.push(r),e[r]-=t.cellBorderWidth.getValue();this.setStylePropertyOfBlock("border-left",f,null,c)}this.setStylePropertyOfBlock("padding",t["cell[padding]"].toString(),null,null),this.setProfile(e)},this.setStylePropertyOfBlock=function(t,e,r,o){if(!Array.isArray(r)&&null!==r&&void 0!==r)throw new Error("Row range must be an array!");var i,n,s=this.getBody(),l=[],a=s.length,h=null===r||void 0===r;for(n=0;a>n;n++)i=s[n],(h||-1!==r.indexOf(n))&&i.setStylePropertyOfRange(t,e,o),l.push(i);this.setBody(l)},this.setAllRowWidths=function(t){if("string"!=typeof t&&"number"!=typeof t)throw new Error("Width must be a string or a number!");var e,r,o=this.getBody(),i=[],n=o.length;for(r=0;n>r;r++)e=o[r],e.setWidth(t),i.push(e);this.setBody(i)},this.getStylePropertyOfBlock=function(t,e,r){if(!Array.isArray(e)&&null!==e&&void 0!==e)throw new Error("Row range must be an array!");var o,i,n,s,l=this.getBody(),a=l.length,h=null===e||void 0===e;for(h||(e=e.map(function(t){return 0>t?a+t:t})),i=0;a>i;i++)if(h||-1!==e.indexOf(i))if(o=l[i],s=o.getStylePropertyOfRange(t,r),void 0===n)n=s;else if(n!==s)return;return n},this.update=function(t){var e=this.clone();return e.configureProperties(t),e},this.getStylePropertyOfRangeAsBorderInfo=function(t,e,r){var o=this.getStylePropertyOfBlock(t,e,r),i={style:"none"};if(o){o=o.trim();var n=new RegExp(/\s+/g),s=o.split(n);if(s.length>=3){var l=s.shift(),a=s.shift();0===parseInt(l,10)?i.style="none":(i.style=a,i.width=l,i.color=s.join(" "))}}return i};var o=function(t,e){var r=0,o=[];for(r=0;e>r;r++)o[r]=t+r;return o};this.getCellBorders=function(){var t,e,r,i,n={},s=o(1,this.rowNum()-1),l=o(1,this.colNum()-1),a={topHor:["border-top",[0]],bottomHor:["border-bottom",[-1]],intHor:["border-top",s],leftVer:["border-left",null,[0]],rightVer:["border-right",null,[-1]],intVer:["border-left",null,l]};for(i in a)a.hasOwnProperty(i)&&(e=a[i],r=this.getStylePropertyOfRangeAsBorderInfo(e[0],e[1],e[2]),n[i]="none"!==r.style,void 0===t&&n[i]&&(t=parseInt(r.width,10),n.width=t,n.color=r.color));return n},this.getPhantomTableBorder=function(){var t={style:"none"},e=this.getPhantomTableProperties();return e&&(t=e.getBorder()),t},this.extractPhantomTemplate=function(t){var e="frame";return t&&t.hasOwnProperty(e)?t[e]:void 0},this.loadTemplate=function(t){var e=this.extractProperTemplate(t),r=this.extractPhantomTemplate(t);e.hasOwnProperty("border-width")&&(e["border-style"]="solid"),this.setProperties(e),this.setWidth(e.width),r&&(r.width=e.width,this.setPhantomTemplate(r));var o,i,n=parseInt(t.rows,10),s=t.row;if("number"==typeof n){for(s.cell=t.cell,console.log(s),o=0;n>o;o++)i=new Row,0===o&&s&&s["border-first"]&&i.setStyleProperty("border-top",s.root.style["border-width"]+"px solid "+s.root.style["border-color"]),o===n-1&&t.row["border-last"]&&console.log("create border of the last row"),o>0&&n-1>o&&t.row["border-middle"]&&console.log("create border of the middle row"),console.log("loading row template:",s),i.loadTemplate(s),this.appendRow(i);console.log("rows: "+t.rows,", columns: "+t.columns)}},this.setPhantomTemplate=function(t){var e=new Properties(t);e.setMode(Properties.MODE_STYLE),this.setPhantomTableProperties(e),this.setPhantomRowProperties(e),this.setPhantomCellProperties(e)}}Table.prototype=Object.create(Tag.prototype),Table.prototype.characteristicFunction=function(t){return t instanceof Element&&"table"===t.tagName.toLowerCase()};